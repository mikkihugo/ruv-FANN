#!/usr/bin/env node

import { spawn } from 'child_process';
import path from 'path';
import fs from 'fs';
import os from 'os';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Check if Deno is installed
function checkDeno() {
  try {
    const denoPath = process.env.PATH.includes('.deno/bin') ? 'deno' : path.join(os.homedir(), '.deno', 'bin', 'deno');
    import('child_process').then(cp => cp.execSync(`${denoPath} --version`, { stdio: 'ignore' }));
    return denoPath;
  } catch {
    try {
      import('child_process').then(cp => cp.execSync('deno --version', { stdio: 'ignore' }));
      return 'deno';
    } catch {
      return null;
    }
  }
}

const denoPath = checkDeno();

if (!denoPath) {
  console.error('Error: Deno is not installed.');
  console.error('');
  console.error('Please install Deno first:');
  console.error('  curl -fsSL https://deno.land/x/install/install.sh | sh');
  console.error('');
  console.error('Or on Windows:');
  console.error('  irm https://deno.land/install.ps1 | iex');
  process.exit(1);
}

// Use the simple CLI JavaScript file which doesn't have TypeScript issues
const cliPath = path.join(__dirname, '..', 'src', 'cli', 'simple-cli.js');

// Run the CLI with Deno
const deno = spawn(denoPath, ['run', '--allow-all', cliPath, ...process.argv.slice(2)], {
  stdio: 'inherit',
  cwd: path.join(__dirname, '..')
});

deno.on('error', (err) => {
  console.error('Failed to start Claude-Flow:', err.message);
  process.exit(1);
});

deno.on('close', (code) => {
  process.exit(code || 0);
});